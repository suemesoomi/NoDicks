<!DOCTYPE html>
<title>No Dicks</title>

<meta name="apple-mobile-web-app-capable" content="yes">
<meta name = "viewport" content = "width = device-width, minimum-scale = 1.0, maximum-scale = 1.0, user-scalable = no">
<link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,300' rel='stylesheet' type='text/css'>
<link rel="stylesheet" type="text/css" href="css/decorate.css"/>


<div id="uploadScreen">
  <img src = "img/upload_bg.png" id="uploadBG">
  <div id="header"> <img src="img/NoDicksLogo.png"> <p>Received a dick pic without Consent?<br>Was it gross?<br>Then make it un-gross!<br>The power is in your hands.</p> </div>
  <img id="photoInputButton" src="img/uploadButton.png">
  <input id="photoInput" type="file" accept="image/*">
  
</div>

<div id="decorateScreen">
  
  <div id="photo"> </div>
  <canvas id="cropShape"></canvas>  
  <div id="stampContainer"></div>
  <canvas id="canvas"></canvas>
  
  <div id="decorateNav">
    <div id="uploadBack"> Back </div>
    <div id="decorateDone"> Save </div>
  </div>
  
  <div id="tools">
    <div id="toolButtons">
      <div class = "navButtons buttons" id="cropButton"><img src="img/button_crop.png"><img src="img/button_crop_on.png" id="active">Crop</div>
<!--      <div class = "buttons" id="adjustButton">Adjust</div>-->
      <div class = "navButtons buttons" id="stampButton"><img src="img/button_stamp.png"><img src="img/button_stamp_on.png" id="active">Stamp</div>
      <div class = "navButtons buttons" id="drawButton"><img src="img/button_draw.png"><img src="img/button_draw_on.png" id="active">Draw</div>
<!--      <div class = "buttons" id="bgButton">Bg</div>-->
    </div>
    <div id="crop">  </div>
    <div id="stampAdjust">
      <div id="delete">Delete</div>
    </div>
    <div id="stamps">
      <div id="buttonSwitcher">
        <div id="hairButtons"> 
          <img src="img/hair_60-black.png" class="hairButtons"/>
          <img src="img/hair_beehive-black.png" class="hairButtons"/>
          <img src="img/hair_bowl-black.png" class="hairButtons"/>
          <img src="img/hair_braids-black.png" class="hairButtons"/>
          <img src="img/hair_combover-black.png" class="hairButtons"/>
          <img src="img/hair_dreads-black.png" class="hairButtons"/>
          <img src="img/hair_flip-black.png" class="hairButtons"/>
          <img src="img/hair_fro-black.png" class="hairButtons"/>
          <img src="img/hair_mohawk-black.png" class="hairButtons"/>
          <img src="img/hair_pigtail-black.png" class="hairButtons"/>
          <img src="img/hair_pony-black.png" class="hairButtons"/>
          <img src="img/hair_wolverine-black.png" class="hairButtons"/>
          <img src="img/hair_60-blonde.png" class="hairButtons"/>
          <img src="img/hair_beehive-blonde.png" class="hairButtons"/>
          <img src="img/hair_bowl-blonde.png" class="hairButtons"/>
          <img src="img/hair_braids-blonde.png" class="hairButtons"/>
          <img src="img/hair_combover-blonde.png" class="hairButtons"/>
          <img src="img/hair_dreads-blonde.png" class="hairButtons"/>
          <img src="img/hair_flip-blonde.png" class="hairButtons"/>
          <img src="img/hair_fro-blonde.png" class="hairButtons"/>
          <img src="img/hair_mohawk-blonde.png" class="hairButtons"/>
          <img src="img/hair_pigtail-blonde.png" class="hairButtons"/>
          <img src="img/hair_pony-blonde.png" class="hairButtons"/>
          <img src="img/hair_wolverine-blonde.png" class="hairButtons"/>
        </div>     
        <div id="hatsButtons"> 
          <img src="img/hat_sun.png" class="hatButtons" id="hatSun_Button"/>
          <img src="img/hat_catears.png" class="hatButtons" id="hatCat_Button"/>
          <img src="img/hat_cowboy.png" class="hatButtons" id="hatCat_Button"/>
          <img src="img/hat_fairy.png" class="hatButtons" id="hatCat_Button"/>
          <img src="img/hat_madeline.png" class="hatButtons" id="hatCat_Button"/>
          <img src="img/hat_party.png" class="hatButtons" id="hatCat_Button"/>
          <img src="img/hat_pirate.png" class="hatButtons" id="hatCat_Button"/>
          <img src="img/hat_sun.png" class="hatButtons" id="hatCat_Button"/>
          <img src="img/hat_tophat.png" class="hatButtons" id="hatCat_Button"/>
          <img src="img/hat_toque.png" class="hatButtons" id="hatCat_Button"/>
          <img src="img/hat_unicorn.png" class="hatButtons" id="hatCat_Button"/>
          <img src="img/hat_winter.png" class="hatButtons" id="hatCat_Button"/>
        </div>
        <div id="dressButtons" >
          <img src="img/dress_coat.png" class="dressButtons" id="dressCoat_Button"/>
          <img src="img/dress_dress.png" class="dressButtons"/>
          <img src="img/dress_hoodie.png" class="dressButtons"/>
          <img src="img/dress_jacket.png" class="dressButtons"/>
          <img src="img/dress_pants.png" class="dressButtons"/>
          <img src="img/dress_shorts.png" class="dressButtons"/>
          <img src="img/dress_shortShorts.png" class="dressButtons"/>
          <img src="img/dress_skirt.png" class="dressButtons"/>
          <img src="img/dress_skort.png" class="dressButtons"/>
          <img src="img/dress_sweater.png" class="dressButtons"/>
          <img src="img/dress_tank.png" class="dressButtons"/>
          <img src="img/dress_tie.png" class="dressButtons"/>
          <img src="img/dress_tshirt.png" class="dressButtons"/>
        </div>
        <div id="faceButtons"> 
          <img src="img/face_cute-happy.png" class="faceButtons"/>
          <img src="img/face_cute-sad.png" class="faceButtons"/>
          <img src="img/face_cute-domo.png" class="faceButtons"/>
          <img src="img/face_content.png" class="faceButtons"/>
          <img src="img/face_err.png" class="faceButtons"/>
          <img src="img/face_frown.png" class="faceButtons"/>
          <img src="img/face_happy.png" class="faceButtons"/>
          <img src="img/face_noo.png" class="faceButtons"/>
          <img src="img/face_smile.png" class="faceButtons"/>
          <img src="img/face_squiggle.png" class="faceButtons"/>
          <img src="img/face_vampy.png" class="faceButtons"/>
        </div>
        <div id="accessButtons"> 
          <img src="img/access_bowtie.png" class="accessButtons"/>
          <img src="img/access_briefcase.png" class="accessButtons"/>
          <img src="img/access_fanny.png" class="accessButtons"/>
          <img src="img/access_glass.png" class="accessButtons"/>
          <img src="img/access_heartGlass.png" class="accessButtons"/>
          <img src="img/access_jizz.png" class="accessButtons"/>
          <img src="img/access_lightning.png" class="accessButtons"/>
          <img src="img/access_mono.png" class="accessButtons"/>
          <img src="img/access_no.png" class="accessButtons"/>
          <img src="img/access_no1.png" class="accessButtons"/>
          <img src="img/access_pearls.png" class="accessButtons"/>
          <img src="img/access_piercing.png" class="accessButtons"/>
          <img src="img/access_pubes.png" class="accessButtons"/>
          <img src="img/access_purse.png" class="accessButtons"/>
          <img src="img/access_rainbow.png" class="accessButtons"/>
          <img src="img/access_tatt.png" class="accessButtons"/>
        </div>
        <div id="myButtons"> 
          <img src="img/myButton_1.png" class="myButtons"/>
        </div>
      </div>
      <div id="stampCategories">
        <div class = "buttons" data-set-class="hair"><img src="img/button_hair.png"><img src="img/button_hair_on.png" id="active"> Hair</div>
        <div class = "buttons" data-set-class="hats"><img src="img/button_hat.png"><img src="img/button_hat_on.png" id="active"> Hats</div>
        <div class = "buttons" data-set-class="dress"><img src="img/button_dress.png"><img src="img/button_dress_on.png" id="active"> Dress</div>
        <div class = "buttons" data-set-class="face"><img src="img/button_face.png"><img src="img/button_face_on.png" id="active"> Face</div>
        <div class = "buttons" data-set-class="access"><img src="img/button_access.png"><img src="img/button_access_on.png" id="active">Access</div>
        <div class = "buttons" data-set-class="my"><img src="img/button_my.png"><img src="img/button_my_on.png" id="active">Collected</div>
      </div>  
    </div>
    
    <div id="draw">
      <div id="eraser">Eraser</div>
      <input id="brushSize" type = "range" name ="brushSize" min="1" max="30" value ="15">
      <input id="hue" type = "range" name ="hue" min="0" max="360" value ="20">
      <div id="previewSlider"></div>
     </div>
    
  </div>
  
  <canvas id="savePhoto"></canvas>
  <img id="saveImg">
</div>  

<script src="js/jquery-2.1.4.min.js"></script>
<script src="js/load-image.all.min.js"></script>
<script src="js/hammer.min.js"></script>
<script src="js/jquery.hammer.js"></script>
<script src="js/stamp.js"></script>
<script src="js/draw.js"></script>
<script src="js/fastclick.js"></script> 
  
<script>
  
  var canvas = document.getElementById('canvas'),
      context = canvas.getContext('2d');

  document.documentElement.offsetWidth; //force layout
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;

  context.rect(0,0,canvas.width, canvas.height);
  
  draw();
  
  Origami.fastclick(document.body);
  
  //PHOT INPUT HACK
  $("#photoInputButton").click(function(){
    $("phtotoInput").click();
  });

//CROP
  var cropShape = new Image();
  cropShape.src = "img/cropSourceAtop.png";
  //COPY FOR DECORATEBACK BUTTON
  var startRotation = 0;
  var rotation = 0;
  var startScale = 1;
  var scale = 0;
  var startX = 0;
  var startY = 0;
  var x = 0;
  var y = 0;
  function cropHammer(){
    var $canvasPhoto = $(canvasPhoto);
    var $crop = $("#cropOverlay");
    $crop.hammer();
    $crop.data("hammer").get("rotate").set({enable:true});
    $crop.data("hammer").get("pinch").set({enable:true});
    
    $crop.bind("rotate", "pinch", function(e){
      rotation = e.gesture.rotation + startRotation;
      scale = e.gesture.scale-1 + startScale;
      x = startX + e.gesture.deltaX;
      y = startY + e.gesture.deltaY;

      $canvasPhoto.css({
         "transform": "translate("+x+"px,"+y+"px) rotate("+rotation+"deg) scale("+scale+","+scale+")",
          "-webkit-transform": "translate("+x+"px,"+y+"px) rotate("+rotation+"deg) scale("+scale+","+scale+")"
      });
    });
    $crop.bind("rotateend", "pinchend", function(e){
        startRotation = rotation;
        startScale = scale;
        startX = x;
        startY = y;
      });
    $crop.bind("pan", function(e){
        x = startX + e.gesture.deltaX;
        y = startY + e.gesture.deltaY;

        $canvasPhoto.css({
          "transform": "translate("+x+"px,"+y+"px) rotate("+startRotation+"deg) scale("+startScale+","+startScale+")",
          "-webkit-transform": "translate("+x+"px,"+y+"px) rotate("+startRotation+"deg) scale("+startScale+","+startScale+")"  
        });
      });
    $crop.bind("panend", function(e){
      startX = startX+e.gesture.deltaX;
      startY = startY+e.gesture.deltaY;
  });
  }
  
  var canvasCrop = document.getElementById('cropShape'),
      contextCrop = canvasCrop.getContext('2d');
  
  
  $("#stampButton, #drawButton").click(function(){
    if($("#tools").hasClass("crop")){
      $("#cropShape").addClass('active');
      canvasCrop.width = canvas.width;
      canvasCrop.height = canvas.height;
      var cropShapeScale = canvasCrop.height/cropShape.height;

      contextCrop.save();    
      var x = (canvasCrop.width/2 - (canvasPhoto.width*startScale)/2) + startX;
      var y = (canvasCrop.height/2 - (canvasPhoto.height*startScale)/2) + startY;
      contextCrop.translate(x, y);
      contextCrop.scale(startScale, startScale);
      contextCrop.translate(canvasPhoto.width/2, canvasPhoto.height/2);
      contextCrop.rotate(startRotation*Math.PI/180);
      contextCrop.translate(-canvasPhoto.width/2, -canvasPhoto.height/2);
      contextCrop.drawImage(canvasPhoto,0,0);
      contextCrop.restore();

      contextCrop.globalCompositeOperation="destination-in";
      contextCrop.drawImage(cropShape,((canvasCrop.width/2)-((cropShape.width*cropShapeScale)/2)), 0, (cropShape.width*cropShapeScale), canvasCrop.height);

      $("#photo").removeClass();
      $("#stampContainer").css("display","");
    }
  });
  
  //TOOL BUTTONS  
  $("#drawButton").click(function(){
    $(".navButtons").removeClass("active");
    $(this).addClass("active");
    $("#draw").addClass('active');
    $("#canvas").css("pointer-events","");
    $("#tools").removeClass().addClass("draw");
    $("#cropOverlay").removeClass("active");
  });
  $("#stampButton").click(function(){
    $(".navButtons").removeClass("active");
    $(this).addClass("active");
    $("#canvas").css("pointer-events","none");
    $("#cropOverlay").removeClass("active");
    $("#tools").removeClass().addClass("stamp");
    $("#draw").removeClass('active');
  });
  $("#cropButton").click(function(){ 
    if($("#tools").hasClass("draw") || $("#tools").hasClass("stamp") || $("#tools").hasClass("stampAdjust")){
      $("#photo").addClass("active");
      $("#cropShape").removeClass('active');
      contextCrop.clearRect(0,0,canvas.width, canvas.height);
      $("#stampContainer").css("display","none");
    }
    $(".navButtons").removeClass("active");
    $(this).addClass("active");
    $("#canvas").css("pointer-events","none");
    $("#draw").removeClass('active');
    $("#tools").removeClass().addClass("crop");
    $("#cropOverlay").addClass("active");
//    $("#tools").css("height","49px");
    cropHammer();
  });
    
  
//STAMP BUTTONS  
  $("#stampCategories .buttons").click(function(){
    var className = $(this).data('set-class');
    $("#stampCategories .buttons").removeClass("active");
    $(this).addClass("active");
    $("#buttonSwitcher").removeClass().addClass(className);
  });
  
  var stamps = [];
  stamp();
  
//INSERT PHOTO & CREATE CANVAS CALLED PHOTO
  var $photoInput = $("#photoInput");
  document.body.className="uploadScreen";
  var canvasPhoto;
  //when we get a photo input, 'change' screen and make canvas named photo with photo
  $photoInput.change(function(){
    document.body.className="decorateScreen";
    loadImage.parseMetaData( //read metadata
      $photoInput[0].files[0],
      function (metaData) {
        loadImage(
          $photoInput[0].files[0],
          function (photo){
            $("#photo").addClass("active");
            $(photo).appendTo("#photo");
            canvasPhoto = photo;
            cropHammer();
          },
          {orientation: metaData.exif && metaData.exif.get('Orientation'), 
           maxWidth: canvas.width, 
           maxHeight: canvas.height, 
//           cover: true,
           contain: true,
           crop: true} 
        );
      }
    );
    $("#tools").removeClass().addClass("crop");
    $("#cropButton").addClass("active");
    $("#stampCategories .buttons:first").click();
    $("#canvas").css("pointer-events","none");
    var $cropOverlay = $('<div>', {
      id: "cropOverlay",
      height: canvas.height,
      width: canvas.width
    }).insertAfter("#photo");
    $("#cropOverlay").addClass("active");
    
  });
//BACK  
  $("#uploadBack").click(function(){
    document.body.className="uploadScreen";
    $("#photo").empty();
    $("#cropOverlay").remove();
    $("#cropShape").removeClass("active");
    $("#photo").addClass("active");
    $(".navButtons").removeClass("active");
    
    //RESET PHOTO TRANSFORMS
    startRotation = 0;
    rotation = 0;
    startScale = 1;
    scale = 0;
    startX = 0;
    startY = 0;
    x = 0;
    y = 0;
    //CLEAR DRAWING
    context.clearRect(0, 0, canvas.width, canvas.height);
    //CLEAR STAMPS
    $("#stampContainer").empty();
    stamps = [];
  });
  
  //SAVE
  $("#decorateDone").click(function(){   
    
    $("#savePhoto").addClass('active');
    $("#saveImg").addClass('active');
    var canvasSave = document.getElementById('savePhoto'),
        contextSave = canvasSave.getContext('2d');
    canvasSave.width = canvas.width;
    canvasSave.height = canvas.height;
    //MAKE WHITE BACKGROUND
    contextSave.rect(0,0,canvasSave.width, canvasSave.height);
    contextSave.fillStyle='white';
    contextSave.fill();

    //COPY CROPPED PHOTO
    contextSave.drawImage(canvasCrop,0,0);
    //COPY STAMPS
    
    //get each $stamp file src & transform
    for (i=0; i < stamps.length; ++i ){
     var transform = stamps[i].data("transform");
     
    contextSave.save();    
     
    var startX = canvasSave.width*0.25;
    var startY= canvasSave.height*0.15;

    var x = (startX + (stamps[i][0].width/2 -(stamps[i][0].width*transform.scale)/2)) + transform.x;
    var y = (startY +(stamps[i][0].height/2 -(stamps[i][0].height*transform.scale)/2)) + transform.y;
    
    contextSave.translate(x, y);
    contextSave.scale(transform.scale, transform.scale);
    contextSave.translate(stamps[i][0].width/2, stamps[i][0].height/2);
    contextSave.rotate(transform.rotation*Math.PI/180);
    contextSave.translate(-(stamps[i][0].width/2), -(stamps[i][0].height/2));
    contextSave.drawImage(stamps[i][0],0,0);
    contextSave.restore();
    
    };
  
    //COPY DRAWING
    contextSave.drawImage(canvas,0,0);
    
    //MAKE INTO PNG
    var dataURL = canvasSave.toDataURL();
//     window.open(dataURL, '_blank');
    document.getElementById("saveImg").src = dataURL;
    
        //ALERT FOR SAVE
    alert("Press and hold on your photo to save!");
    

  });
  
  
                         
</script>